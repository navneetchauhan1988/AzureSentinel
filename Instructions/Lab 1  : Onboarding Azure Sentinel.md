# Lab :  Onboarding Azure Sentinel and Connect Data Sources

Estimated Time: 60 minutes


Azure Sentinel is your bird's-eye view across the enterprise. Put the cloud and large-scale intelligence from decades of Microsoft security experience to work. 
Make your threat detection and response smarter and faster with artificial intelligence (AI)


## Exercise 1: On-board Azure Sentinel 


To on-board Azure Sentinel, you first need to enable Azure Sentinel, and then connect your data sources. Azure Sentinel comes with a number of connectors 
for Microsoft solutions, available out of the box and providing real-time integration, including Microsoft Threat Protection solutions, 
Microsoft 365 sources, including Office 365, Azure AD, Azure ATP, and Microsoft Cloud App Security, and more. 
In addition, there are built-in connectors to the broader security ecosystem for non-Microsoft solutions. 
You can also use common event format, Syslog or REST-API to connect your data sources with Azure Sentinel.  



### Task 1: Enable Azure Sentinel

1.  In the Azure portal, search for Azure Sentinel. 

![image](https://user-images.githubusercontent.com/33748560/89098916-36f45d80-d409-11ea-9275-fa0c6f61111e.png)


2.  Click **+Add**.
3.  Create a new workspace in a new resource group using the East US region if necessary.

![image](https://user-images.githubusercontent.com/33748560/89099216-470d3c80-d40b-11ea-9892-13dfdec8884d.png)


   Note : Default workspaces created by Azure Security Center will not appear in the list; you can't install Azure Sentinel on them. </br> - Azure Sentinel can run on workspaces in any GA region of Log Analytics except the China, Germany and Azure Government regions. Data generated by Azure Sentinel (such as incidents, bookmarks, and alert rules, which may contain some customer data sourced from these workspaces) is saved either in West Europe (for workspaces located in Europe) or East US (for all US-based workspaces, as well as any other region except Europe).


4.  To finish creating the workspace, click **Review and Create**, then click **Create**.
5.  Once the workspace has been created, click **Add Azure Sentinel**.

    ![image](https://user-images.githubusercontent.com/33748560/89099336-17126900-d40c-11ea-9cce-26c8d329ae06.png)
  
### Task 2: Setting Azure Sentinel Workspace Pricing and Data Retention 

Azure Sentinel is billed based on the volume of data ingested for analysis in Azure Sentinel. 
Azure Sentinel offers a flexible and predictable pricing model.​
There are two ways to pay for the Azure Sentinel service: Capacity Reservations and Pay-As-You-Go.​ The cost for Azure Sentinel depends on the pricing tier selected.

1. On Azure Sentinal Page , click **Settings** , verfiy pricing tiers 
2. Click **Workspace settings** 

![image](https://user-images.githubusercontent.com/33748560/89100516-2a760200-d415-11ea-9b09-74771b18af1d.png)

3. On Log Analaytics workspace page , click **Usage and estimated costs**


![image](https://user-images.githubusercontent.com/33748560/89100531-3a8de180-d415-11ea-8170-56d3bd5d09d5.png)

4. Click **Data Retention** 

![image](https://user-images.githubusercontent.com/33748560/89100534-44174980-d415-11ea-986e-d351dc906dda.png)

5. Adjust Data retention slider .


## Exercise 2:   Connect data sources

Azure Sentinel creates connections to services and apps by connecting to the service and forwarding the events and logs to Azure Sentinel. For machines and virtual machines, you can install the Azure Sentinel agent that collects the logs and forwards them to Azure Sentinel. For Firewalls and proxies, Azure Sentinel utilizes a Linux Syslog server. The agent is installed collects the log files and forwards them to Azure Sentinel. 



### Task 1: Service to service integration:




### Connect Azure Activity Log

1.  In the Azure Portal , Search for **Azure Sentinal** , Click Azure Sentinal you created in previous task.

2.  On the menu, select **Data connectors**. This page lets you see the full list of connectors that Azure Sentinel provides and their status.

      ![image](https://user-images.githubusercontent.com/33748560/89099493-4e354a00-d40d-11ea-82b9-8f9465fbecdc.png)

3.  Select **Azure Activity** and click **Open connector page**.

4.  Select **Configure Azure Activity logs**.

     ![image](https://user-images.githubusercontent.com/33748560/89099700-d36d2e80-d40e-11ea-8f0d-b510a36409c8.png)


  On the specific connector page, make sure you have fulfilled all the prerequisites and follow the instructions to connect the data to Azure Sentinel. 
It may take some time for the logs to start syncing with Azure Sentinel.
After you connect, you see a summary of the data in the **Data received** graph, and connectivity status of the data types.

   

5.  Select your Azure subscription then click **Connect**.

     ![image](https://user-images.githubusercontent.com/33748560/89099743-15967000-d40f-11ea-938c-1f470e19f0c9.png)
     
     ![image](https://user-images.githubusercontent.com/33748560/89099776-48406880-d40f-11ea-8f68-816372361687.png)
     
### Connect Azure Active Directory
To Connect Azure active directory with Sentinel,  Azure AD  P1/P2  License is required 

1. Type Azure Active Directoery in free search on azure portal , **Click Azure Active Directory**

![image](https://user-images.githubusercontent.com/33748560/89101232-aa9f6600-d41b-11ea-9916-cf48e6f4ca94.png)

2. On azure AD page, click **Getting Started**

3.click **Get a free trial for Azure AD Premium** 

4.click **Free Trial** and click **Activate**

![image](https://user-images.githubusercontent.com/33748560/89101304-63fe3b80-d41c-11ea-81af-d68a4486d941.png)

5. In the Azure portal, type **Azure Sentinel**. 

![image](https://user-images.githubusercontent.com/33748560/89098916-36f45d80-d409-11ea-9275-fa0c6f61111e.png)

6. Click on **Azure Sentinel**

7. On the menu, select **Data connectors**. This page lets you see the full list of connectors that Azure Sentinel provides and their status.

      ![image](https://user-images.githubusercontent.com/33748560/89099493-4e354a00-d40d-11ea-82b9-8f9465fbecdc.png)

3.  Select **Azure Active Directory** and click **Open connector page**.

4.  Select **Check both boxes Azure Active Directory , Sign-in logs Azure Active Directory Audit logs** and Click **Apply Changes**


![image](https://user-images.githubusercontent.com/33748560/89101329-914ae980-d41c-11ea-8d22-34c9c745daeb.png)

### Task 2 : External solutions via agent:

### Installing Azure Log anaytics  Agent for Linux server 

1. Select **Cloud Shell** in azure portal.

![image](https://user-images.githubusercontent.com/33748560/89263972-cc812e80-d64f-11ea-8484-6e91a1cf8244.png)

2. Click **Create Storage** if prompted

![image](https://user-images.githubusercontent.com/33748560/89263984-d2770f80-d64f-11ea-9ec8-d3ee3df1674c.png)

wait for cloud shell to be launched.


3. Run below commands in cloudshell to Create  a Linux VM

    **az group create --name myResourceGroupVM --location eastus**
    **az vm create --resource-group myResourceGroupVM  --name myVM  --image UbuntuLTS --admin-username azureuser  --generate-ssh-keys**
  
   
                                 
4. Run below command to connect to Linux vm  (replace the PublicIpAdress with your vm's public ip )

   **ssh azureuser@PublicIpAdress**
      
      
5.  Run below command to Install Agent  (Replace the value with your workspace id and the key , you can find them on Agent Management blade of your Log analytics       workspace)
      

   **wget https://raw.githubusercontent.com/Microsoft/OMS-Agent-for-Linux/master/installer/scripts/onboard_agent.sh && sh onboard_agent.sh
   -w "YOUR WORKSPACE ID" -s "YOUR WORKSPACE PRIMARY KEY"**
   
   
 ### Collect event and performance data
 
 1. In Azure portal free search , type  Log Analytics and select the workspace you are looking for
 
 2. Select **Advanced settings ** 
 
 3. Select **Data**, and then select **Syslog**.
 
 4. Check the **Apply below configuration to my machines** check box
 
 5. You add syslog by typing in the name of the log. Enter **Syslog** and then select the plus sign **+**
 
 6. Select **Save** at the top of the page to save the configuration.
 
 7. Select **Linux Performance Counters** to enable collection of performance counters on a Linux computer.
 
 8. Select **Apply below configuration to to my machines** and then select **Add the selected performance counters**. They are added and preset with a ten second       collection sample interval.
 
 9. Select **Save** at the top of the page to save the configuration.
 
 ### Validate the Agent installation
 
 1. On Log analytics Workspace , Select **Agent Management** blade
 
 2. Select **Linux Servers**
 
 ![image](https://user-images.githubusercontent.com/33748560/89268317-fe958f00-d655-11ea-9ef4-563469c3ebd1.png)
 
 3. Click **Go to Logs **
 
 4. Verify the agent properties in the result pane.
 
 5. Enter **Syslog** in query enter and click **Run**
 
 6. Verify the Logs collected from linux machine.
 

 

**Results**: You have now completed this lab.
